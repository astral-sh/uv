# Sync Python releases and create a pull request.
#
# Based on: https://github.com/astral-sh/rye/blob/57b7c089e494138aae29a130afb2e17f447970bf/.github/workflows/sync-python-releases.yml
name: "Sync Python downloads"
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions: {}

jobs:
  sync:
    if: github.repository == 'astral-sh/uv'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          version: "latest"
          enable-cache: true
      - name: Sync Python Releases
        run: |
          uv run -- fetch-download-metadata.py
        working-directory: ./crates/uv-python
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync Sysconfig Targets
        run: ${GITHUB_WORKSPACE}/crates/uv-dev/sync_sysconfig_targets.sh
        working-directory: ./crates/uv-dev
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Python Version Constants
        run: |
          # Extract the latest stable patch version for each minor version from the download metadata
          # We filter out prereleases (those with 'prerelease' field set)
          python3 << 'EOF'
          import json
          import re
          from pathlib import Path

          # Read the download metadata
          metadata_path = Path("crates/uv-python/download-metadata.json")
          with open(metadata_path) as f:
              metadata = json.load(f)

          # Find the latest stable patch version for each minor version
          # We store (patch_number, full_version_string) tuples for proper numeric comparison
          latest_versions = {}
          for key, info in metadata.items():
              if info["name"] != "cpython":
                  continue
              if info.get("prerelease"):
                  continue
              if info.get("variant"):
                  continue

              minor = f"3.{info['minor']}"
              patch = info['patch']
              version = f"{info['major']}.{info['minor']}.{info['patch']}"

              if minor not in latest_versions or patch > latest_versions[minor][0]:
                  latest_versions[minor] = (patch, version)

          # Update the constants in common/mod.rs
          mod_path = Path("crates/uv/tests/it/common/mod.rs")
          content = mod_path.read_text()

          for minor in ["3.14", "3.13", "3.12", "3.11", "3.10"]:
              if minor not in latest_versions:
                  continue
              const_name = f"LATEST_PYTHON_{minor.replace('.', '_')}"
              old_pattern = rf'pub const {const_name}: &str = "[^"]+";'
              new_value = f'pub const {const_name}: &str = "{latest_versions[minor][1]}";'
              content = re.sub(old_pattern, new_value, content)

          mod_path.write_text(content)
          print("Updated Python version constants:")
          for minor in sorted(latest_versions.keys(), key=lambda x: int(x.split('.')[1]), reverse=True):
              print(f"  {minor}: {latest_versions[minor][1]}")
          EOF

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          commit-message: "Sync latest Python releases"
          add-paths: |
            crates/uv-python/download-metadata.json
            crates/uv-dev/src/generate_sysconfig_mappings.rs
            crates/uv-python/src/sysconfig/generated_mappings.rs
            crates/uv/tests/it/common/mod.rs
          branch: "sync-python-releases"
          title: "Sync latest Python releases"
          body: "Automated update for Python releases."
          base: "main"
          draft: true
