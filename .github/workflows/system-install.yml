name: System Install

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CARGO_TERM_COLOR: always
  RUSTUP_MAX_RETRIES: 10
  PYTHON_VERSION: "3.12"

jobs:
  # Install Python on Ubuntu.
  install-ubuntu:
    name: "Install Python on Ubuntu"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "Install Rust toolchain"
        run: rustup update

      - uses: Swatinem/rust-cache@v2
#        with:
#          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: "Build"
        run: cargo build

      - name: "Validate global Python install"
        run: python3.12 check_system_python.py $(which python3.12) --uv ./target/debug/uv

  # Install Python on macOS.
  install-macos:
    name: "Install Python on macOS"
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: "Install Python"
        run: brew install python@3.8

      - name: "Install Rust toolchain"
        run: rustup update

      - uses: Swatinem/rust-cache@v2
#        with:
#          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: "Build"
        run: cargo build

      - name: "Validate global Python install"
        run: python3.8 check_system_python.py $(which python3.8) --uv ./target/debug/uv

  # Install Python on Windows.
  install-windows:
    name: "Install Python on Windows"
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: "Install Python"
        run: choco install python

#      - name: "Install Rust toolchain"
#        run: rustup update
#
#      - uses: Swatinem/rust-cache@v2
##        with:
##          save-if: ${{ github.ref == 'refs/heads/main' }}
#
#      - name: "Build"
#        run: cargo build

      # Print Python path.
      - name: "Print Python path"
        run: |
          echo "Python path: $(which python3.12)"

#      # Print uv path.
#      - name: "Print uv path"
#        run: |
#          echo "uv path: $(which ./target/debug/uv)"

      - name: "Validate global Python install"
        run: C:\ProgramData\Chocolatey\bin\python3.12 check_system_python.py C:\ProgramData\Chocolatey\bin\python3.12 --uv ./target/debug/uv
