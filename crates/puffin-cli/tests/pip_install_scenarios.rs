#![cfg(all(feature = "python", feature = "pypi"))]
/// Generated by `scripts/scenarios/generate.py`
use std::process::Command;

use anyhow::Result;
use insta_cmd::_macro_support::insta;
use insta_cmd::{assert_cmd_snapshot, get_cargo_bin};

use common::{create_venv_py312, BIN_NAME, INSTA_FILTERS};

mod common;

/// requires-package-does-not-exist
///
/// The user requires any version of package `a` which does not exist.
#[test]
fn requires_package_does_not_exist() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-package-does-not-exist-e4666012")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 2
        ----- stdout -----

        ----- stderr -----
        error: Package `requires-package-does-not-exist-e4666012-a` was not found in the registry.
        "###);
    });

    Ok(())
}

/// requires-exact-version-does-not-exist
///
/// The user requires an exact version of package `a` but only other versions exist
#[test]
fn requires_exact_version_does_not_exist() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-exact-version-does-not-exist-c640da4b")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 1
        ----- stdout -----

        ----- stderr -----
          × No solution found when resolving dependencies:
          ╰─▶ Because there is no version of
              requires-exact-version-does-not-exist-c640da4b-a available matching
              ==2.0.0 and requires-exact-version-does-not-exist-c640da4b==0.0.0
              depends on requires-exact-version-does-not-exist-c640da4b-a==2.0.0,
              requires-exact-version-does-not-exist-c640da4b==0.0.0 is forbidden.
              And because there is no version of
              requires-exact-version-does-not-exist-c640da4b
              available matching <0.0.0 | >0.0.0 and root depends on
              requires-exact-version-does-not-exist-c640da4b, version solving failed.
        "###);
    });

    Ok(())
}

/// requires-greater-version-does-not-exist
///
/// The user requires a version of `a` greater than `1.0.0` but only smaller or equal versions exist
#[test]
fn requires_greater_version_does_not_exist() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-greater-version-does-not-exist-ceb05782")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: true
        exit_code: 0
        ----- stdout -----

        ----- stderr -----
        Resolved 2 packages in [TIME]
        Downloaded 2 packages in [TIME]
        Installed 2 packages in [TIME]
         + requires-greater-version-does-not-exist-ceb05782==0.0.0
         + requires-greater-version-does-not-exist-ceb05782-a==1.0.0
        "###);
    });

    Ok(())
}

/// requires-less-version-does-not-exist
///
/// The user requires a version of `a`  less than `1.0.0` but only larger versions exist
#[test]
fn requires_less_version_does_not_exist() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-less-version-does-not-exist-14de847d")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 1
        ----- stdout -----

        ----- stderr -----
          × No solution found when resolving dependencies:
          ╰─▶ Because there is no version of
              requires-less-version-does-not-exist-14de847d-a available matching
              <2.0.0 and requires-less-version-does-not-exist-14de847d==0.0.0
              depends on requires-less-version-does-not-exist-14de847d-a*,
              requires-less-version-does-not-exist-14de847d==0.0.0 is forbidden.
              And because there is no version of
              requires-less-version-does-not-exist-14de847d
              available matching <0.0.0 | >0.0.0 and root depends on
              requires-less-version-does-not-exist-14de847d, version solving failed.
        "###);
    });

    Ok(())
}

/// transitive-requires-package-does-not-exist
///
/// The user requires package `a` but `a` package `b` which does not exist
#[test]
fn transitive_requires_package_does_not_exist() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("transitive-requires-package-does-not-exist-15763ba4")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 2
        ----- stdout -----

        ----- stderr -----
        error: Package `transitive-requires-package-does-not-exist-15763ba4-b` was not found in the registry.
        "###);
    });

    Ok(())
}

/// requires-direct-incompatible-versions
///
/// The user requires two incompatible, existing versions of package `a`
#[test]
fn requires_direct_incompatible_versions() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-direct-incompatible-versions-3a64108d")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 2
        ----- stdout -----

        ----- stderr -----
        error: Conflicting versions for `requires-direct-incompatible-versions-3a64108d-a`: `requires-direct-incompatible-versions-3a64108d-a==1.0.0` does not intersect with `requires-direct-incompatible-versions-3a64108d-a==2.0.0`
        "###);
    });

    Ok(())
}

/// requires-transitive-incompatible-with-root-version
///
/// The user requires package `a` and `b` but `a` requires a different version of `b`
#[test]
fn requires_transitive_incompatible_with_root_version() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-transitive-incompatible-with-root-version-8af9847a")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 1
        ----- stdout -----

        ----- stderr -----
          × No solution found when resolving dependencies:
          ╰─▶ Because there is no version of
              requires-transitive-incompatible-with-root-version-8af9847a-a
              available matching <1.0.0 | >1.0.0 and
              requires-transitive-incompatible-with-root-version-8af9847a-a==1.0.0
              depends on
              requires-transitive-incompatible-with-root-version-8af9847a-b==2.0.0,
              requires-transitive-incompatible-with-root-version-8af9847a-a depends on
              requires-transitive-incompatible-with-root-version-8af9847a-b==2.0.0.
              And because
              requires-transitive-incompatible-with-root-version-8af9847a==0.0.0
              depends on requires-transitive-incompatible-with-root-version-8af9847a-a
              and requires-transitive-incompatible-with-root-version-8af9847a==0.0.0
              depends on
              requires-transitive-incompatible-with-root-version-8af9847a-b==1.0.0,
              requires-transitive-incompatible-with-root-version-8af9847a==0.0.0 is
              forbidden.
              And because there is no version of
              requires-transitive-incompatible-with-root-version-8af9847a
              available matching <0.0.0 | >0.0.0 and root depends on
              requires-transitive-incompatible-with-root-version-8af9847a, version
              solving failed.
        "###);
    });

    Ok(())
}

/// requires-transitive-incompatible-with-transitive
///
/// The user requires package `a` and `b`; `a` and `b` require different versions of `c`
#[test]
fn requires_transitive_incompatible_with_transitive() -> Result<()> {
    let temp_dir = assert_fs::TempDir::new()?;
    let cache_dir = assert_fs::TempDir::new()?;
    let venv = create_venv_py312(&temp_dir, &cache_dir);

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(Command::new(get_cargo_bin(BIN_NAME))
            .arg("pip-install")
            .arg("requires-transitive-incompatible-with-transitive-cb77ed7e")
            .arg("--extra-index-url")
            .arg("https://test.pypi.org/simple")
            .arg("--cache-dir")
            .arg(cache_dir.path())
            .env("VIRTUAL_ENV", venv.as_os_str())
            .current_dir(&temp_dir), @r###"
        success: false
        exit_code: 1
        ----- stdout -----

        ----- stderr -----
          × No solution found when resolving dependencies:
          ╰─▶ Because there is no version of
              requires-transitive-incompatible-with-transitive-cb77ed7e-b
              available matching <1.0.0 | >1.0.0 and
              requires-transitive-incompatible-with-transitive-cb77ed7e-b==1.0.0
              depends on
              requires-transitive-incompatible-with-transitive-cb77ed7e-c==2.0.0,
              requires-transitive-incompatible-with-transitive-cb77ed7e-b depends on
              requires-transitive-incompatible-with-transitive-cb77ed7e-c==2.0.0.
              And because
              requires-transitive-incompatible-with-transitive-cb77ed7e-a==1.0.0
              depends on
              requires-transitive-incompatible-with-transitive-cb77ed7e-c==1.0.0
              and there is no version of
              requires-transitive-incompatible-with-transitive-cb77ed7e-a
              available matching <1.0.0 | >1.0.0,
              requires-transitive-incompatible-with-transitive-cb77ed7e-b *,
              requires-transitive-incompatible-with-transitive-cb77ed7e-a * are
              incompatible.
              And because
              requires-transitive-incompatible-with-transitive-cb77ed7e==0.0.0
              depends on requires-transitive-incompatible-with-transitive-cb77ed7e-b
              and requires-transitive-incompatible-with-transitive-cb77ed7e==0.0.0
              depends on requires-transitive-incompatible-with-transitive-cb77ed7e-a,
              requires-transitive-incompatible-with-transitive-cb77ed7e==0.0.0 is
              forbidden.
              And because there is no version of
              requires-transitive-incompatible-with-transitive-cb77ed7e
              available matching <0.0.0 | >0.0.0 and root depends on
              requires-transitive-incompatible-with-transitive-cb77ed7e, version
              solving failed.
        "###);
    });

    Ok(())
}
